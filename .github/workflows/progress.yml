name: Update Progress Bar

on:
  schedule:
    - cron: "0 0 * * *" # 每天 UTC 0 点触发
  workflow_dispatch: # 手动触发

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Update Progress
        run: python - <<'EOF'
import datetime
import base64
import re

# 计算进度
start = datetime.date(2025, 1, 1)
end = datetime.date(2035, 1, 1)
today = datetime.date.today()
total_days = (end - start).days
passed_days = (today - start).days
progress = min(max(passed_days / total_days, 0), 1)
percent = int(progress * 100)

# 生成 SVG
width, height = 400, 30
filled_width = int(width * progress)

svg_content = f'''<svg xmlns="http://www.w3.org/2000/svg" width="{width}" height="{height}">
<defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
    <stop offset="0%" style="stop-color:#ff80bf;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#ff0080;stop-opacity:1" />
    </linearGradient>
    <radialGradient id="stars" cx="50%" cy="50%" r="50%">
    <stop offset="0%" stop-color="white" stop-opacity="0.8"/>
    <stop offset="100%" stop-color="white" stop-opacity="0"/>
    </radialGradient>
</defs>
<rect width="{width}" height="{height}" fill="#1a1a2e" rx="15" ry="15"/>
<rect width="{filled_width}" height="{height}" fill="url(#grad)" rx="15" ry="15"/>
<text x="{width/2}" y="{height/2+5}" font-size="14" text-anchor="middle" fill="white">{percent}%</text>
</svg>'''

# Base64 编码
svg_base64 = base64.b64encode(svg_content.encode('utf-8')).decode('utf-8')
markdown_img = f'![Progress](data:image/svg+xml;base64,{svg_base64})'

# 更新 README.md
with open("README.md", "r", encoding="utf-8") as f:
    content = f.read()

content = re.sub(
    r'<!--progress-->.*?<!--endprogress-->',
    f'<!--progress-->\n{markdown_img}\n<!--endprogress-->',
    content,
    flags=re.DOTALL
)

with open("README.md", "w", encoding="utf-8") as f:
    f.write(content)
EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update progress bar [skip ci]" || echo "No changes"
          git push
